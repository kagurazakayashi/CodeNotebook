# vi (Visual) 文本编辑器

启动 vi: `vi [filename]`

# 两种模式
vi 编辑器命令采用快捷键，如果输入一个字符可能是文件内容也可能是命令，所以提供两种模式：
- `命令模式` ( `Command Mode` )，输入控制命令。
- `插入模式` ( `Insert Mode` )，编辑文件。

## 启动 vi 时，进入`命令模式`。
- 在插入模式时，按 `Esc` 进入`命令模式`。
- 输入插入命令，进入`插入模式`。插入模式进入命令：
  - `a`: 从 光标 后面 开始输入文本
  - `A`: 从 光标的行 后面 开始输入文本
  - `i`: 从 光标 前面 开始输入文本
  - `I`: 从 光标的行 前面 开始输入文本
  - `o`: 在 光标的行 后面 插入一行
  - `O`: 在 光标的行 前面 插入一行
```
|命令| → a,A,i,I,o,O → |插入|
|模式| ←     ESC     ← |模式|
```

# 命令模式命令
- `:help`:     帮助
- `:q`:        退出vi
- `:w <另存为>`:  保存
- `:w! <另存为>`: 保存（覆盖已有文件）
- `:wq`:       保存并退出
- `:q!`:       不保存并退出
- `:! <命令>`:   执行 Shell 命令
- `:r <文件名>`:  读和插入指定文件内容到当前光标位置（粘贴自）

## 命令模式快捷键
- `d`: 删除字( `w`ord ), 行( line )
- `u`: 撤销最后的编辑操作（重做）
- `y`: 复制(yank)
- `p`: 在当前行 后 粘贴已复制或删除的行
- `P`: 在当前行 前 粘贴已复制或删除的行
- `L`: →
- `H`: ←
- `J`: ↓
- `K`: ↑
- `0`: 回到本行开头

# 命令的格式
一般命令的按键语法如下：
- `[#1]operation [#2]target`
  - #1 是可选的数字，指定操作的次数
  - operation 指定操作
  - #2 是可选的数字，指定操作影响的目标数目
  - target 指定操作的目标

- 字(`word`)是空字符(空格、回车、换行)分割的字符串
  - `aaa bbb ccc`
- 如果当前字是操作的目标，输入w word
- 如果当前行是操作的目标，目标的语法和操作的语法相同。

## 命令举例
- `dw`: 删除当前光标所在的字
  - `aaa bbb ccc` -> `bbb ccc`
  - `^          `
  - `aaa bbb ccc` -> `abbb ccc`
  - ` ^         `
- `d5w` / `5dw`: 删除5个字(`w`ord)，从当前光标位置开始
  - `aaa bbb ccc ddd eee fff` -> `fff`
  - `^                      `
  - `5dw`: 删除一个字，执行5次
  - `d5w`: 一次删除5个字，执行1次
  - `2d3w`: 删除3个字，执行2次，实际删除6个字 = `6dw` = `d6w`
- `dd`: 删除光标所在的1行（如果当前行是操作的目标，目标的语法和操作的语法相同）
- `2dd`: 删除2行，从当前行开始
  - `aaa` -> `ccc`
  - `bbb`
  - `ccc`
- `:2,3d`: 删除第2-3行
  - `aaa` -> `aaa`
  - `bbb` -> `ddd`
  - `ccc`
  - `ddd`
- `yy`: 复制当前行
- `1G`: 把光标移动到文件的第1行
  - `5G`: 把光标移动到文件的第5行
- `G`: 把光标移动到文件的第最后1行
- `dG`: 删除当前行和之后的所有行

# 查找和替换

## 查找
`/str`: 查找 str 字符串
1. 光标移动到 从哪开始找 的位置。
2. 直接输入 `/` （不是 `:/` ）
3. 输入查找关键字，例如 `/bbb`
4. 按 `n` 查找下一个

## 替换
`:[range]s/old_string/new_string[/option]`

- `range`: 指定搜索范围，如果忽略，那么指定当前行
- `s`: 指定替换命令
- `/`: 搜索定界符
- `old_string`: 将要被替换的文本
- `/`: 替换定界符
- `new_string`: 替换之后的新文本
- `/option`: 修饰符，g表示全部(global)

### 替换命令举例
- `:s/john/jane/`:      把john替换为jane，在当前行中，替换1次。
- `:s/john/jane/g`:     把john替换为jane，在当前行中，全部替换。
- `:1,10s/john/jane/g`: 把john替换为jane，在1-10行中，全部替换。
- `:1,$s/john/jane/g`:  把john替换为jane，在整个文件中，全部替换。

# 设置 vi 环境
使用 `:set` 命令设置 vi 工作环境。

| 选项       | 缩写 |  功能  |
| ---------- | --- | ---------- |
| autoindent | ai  | 自动缩进 |
| ignorecase | ic  | 忽略大小写 |
| number     | nu  | 行号 |
| showmode   | smd | 显示模式 |
| warpmargin | wm  | 换行便捷 |
| tabstop    | ts  | 水平制表位 |

## 例子
- `:set nu`: 显示行号

## 设置 tab 键为 4个空格：
```
set tabstop=4     表示一个 tab 显示出来是多少个空格的长度，默认 8。
set softtabstop=4 表示在编辑模式的时候按退格键的时候退回缩进的长度，当使用 expandtab时特别有用。
set shiftwidth=4  表示每一级缩进的长度，一般设置成跟 softtabstop 一样。
set expandtab     当设置成 expandtab 时，缩进用空格来表示，noexpandtab 则是用制表符表示一个缩进。
```

# 持久设置
- 设置环境只对当前会话有效。
- 可以把环境设置保存在用户主目录的 `~/.exrc` 文件中，可单行可多行。
  - 单行： `set ts=4 nu ai`